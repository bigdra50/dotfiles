# GitHub Pull Request ガイド

## プルリクエスト作成方針

### 基本原則

1. **機能レベルでの変更管理**
2. **レビュー可能な粒度**
3. **明確な目的と背景の記述**
4. **テスト完了状態での提出**

### PRタイトルの命名規則

```
[type]: 簡潔な機能説明

例:
feat: ユーザー認証機能の追加
fix: ログイン時のメモリリーク修正
refactor: API クライアントの整理
docs: セットアップガイドの更新
```

## PRに含めるべき情報フレームワーク

### 情報の分担と範囲

PRには**開発期間中に確定する情報**を包括的に記録します：

| 要素 | 内容 | 例 |
|------|------|-----|
| **What** | 何を変更したか（機能レベル） | `JWT認証システムを導入` |
| **Why** | なぜ変更したか（ビジネス価値） | `セキュリティ要件強化のため` |
| **How** | どのように実装したか（設計・技術選択） | `express-jwt + Redis セッション管理` |
| **Impact** | 何に影響するか（影響範囲・リスク） | `既存認証との並行稼働、パフォーマンス影響軽微` |

### PR説明テンプレート

```markdown
## 概要 [What + Why]
**何を**: JWT認証システムを導入
**なぜ**: セキュリティ要件強化と将来のOAuth連携準備のため

## 変更内容 [What - 詳細]
### 実装した機能
- [ ] JWT トークン生成・検証機能
- [ ] 認証ミドルウェアの実装
- [ ] リフレッシュトークン機能
- [ ] ログイン・ログアウトエンドポイント

### 修正したファイル
- `src/auth/` - 認証ロジック（3ファイル）
- `src/middleware/` - 認証ミドルウェア（1ファイル）
- `tests/auth/` - テストコード（5ファイル）

## 技術的詳細 [How]
### アーキテクチャ・設計判断
- **JWT実装**: jsonwebtoken ライブラリ使用
- **セッション管理**: Redis でリフレッシュトークン管理
- **セキュリティ**: httpOnly Cookie、CSRF対策済み
- **互換性**: 既存セッション認証と並行稼働

### パフォーマンス・スケーラビリティ
- **予想負荷影響**: +5ms レスポンス時間（軽微）
- **メモリ使用量**: +10MB（Redis キャッシュ）
- **スケーラビリティ**: ステートレス設計で水平スケール対応

## 影響分析 [Impact]
### 既存機能への影響
- ✅ **破壊的変更なし**: 既存APIは完全互換
- ✅ **段階的移行**: 新認証は opt-in 方式
- ⚠️ **注意事項**: Redis 接続設定が必要

### セキュリティ考慮事項
- ✅ **脆弱性対策**: OWASP ガイドライン準拠
- ✅ **暗号化**: HS256 アルゴリズム使用
- ✅ **トークン有効期限**: Access 15分、Refresh 7日

## テスト [Quality Assurance]
### 実施済みテスト
- [x] **単体テスト**: カバレッジ 92% (target: >90%)
- [x] **統合テスト**: API エンドポイント全件
- [x] **セキュリティテスト**: ペネトレーションテスト実施
- [x] **パフォーマンステスト**: 1000 concurrent users

### 手動テスト確認項目
- [x] 正常系ログインフロー
- [x] 異常系エラーハンドリング
- [x] トークン期限切れ時の挙動
- [x] 既存セッション認証との並行動作

## レビューのポイント [Review Focus]
### 優先確認事項
1. **セキュリティ要件**: JWT実装の妥当性
2. **設計判断**: アーキテクチャの適切性
3. **エラーハンドリング**: 異常系処理の網羅性
4. **パフォーマンス**: 負荷影響の許容範囲

### 議論したい設計判断
- トークン有効期限（15分）の妥当性
- リフレッシュトークンローテーション要否
- 既存認証からの移行戦略・タイムライン

## 関連情報 [Context]
### 要求・仕様
- **Issue**: #234 (セキュリティ要件強化)
- **仕様書**: [authentication-requirements.md](docs/auth-spec.md)
- **設計資料**: [jwt-architecture-design.md](docs/design/jwt-arch.md)

### 影響するシステム
- **フロントエンド**: 認証状態管理の更新必要
- **モバイルアプリ**: トークン管理実装必要
- **監視・ログ**: 新しい認証ログ追加

### 今後の予定
- **Phase 2**: OAuth 2.0 対応 (Q2予定)
- **Phase 3**: Single Sign-On 統合 (Q3予定)
```

### PRに含めるべき情報・含めるべきでない情報

#### ✅ 含めるべき情報（開発期間中に確定）

**機能・実装詳細**
- 実装した機能一覧
- 技術選択の理由
- アーキテクチャ設計
- ファイル変更概要

**品質・テスト**
- テスト戦略・実施状況
- カバレッジ・品質指標
- セキュリティ要件への対応
- パフォーマンステスト結果

**影響・リスク分析**
- 既存機能への影響
- 破壊的変更の有無
- デプロイメント要件
- ロールバック計画

**レビュー指針**
- 注意深く確認してほしい箇所
- 設計判断の背景・理由
- 議論・フィードバックを求める点

#### ❌ 含めるべきでない情報（運用後に判明）

**運用・実績情報**
- 本番環境での実際のパフォーマンス
- ユーザーからのフィードバック
- 運用中のインシデント
- ビジネス指標への実際の影響

**長期的評価**
- 数ヶ月後の技術的評価
- 保守性・拡張性の実際の評価
- 他機能への実際の影響

```markdown
# ❌ 悪い例: 運用後情報をPRに含める
## 概要
JWT認証を追加（本番で3ヶ月稼働、ユーザー満足度95%）

# ✅ 良い例: 開発時点の情報のみ
## 概要
JWT認証システムを導入
セキュリティ要件強化と将来のOAuth連携準備のため
```

### PR作成ワークフロー

#### 1. 事前準備
```bash
# ブランチ状態確認
git status
git diff
git diff main...HEAD
git log --oneline main..HEAD
```

#### 2. 変更分析
- mainブランチからの**全ての変更**を確認
- 各コミットの目的と影響を把握
- 機密情報の有無チェック
- 破壊的変更の有無確認

#### 3. PR作成
```bash
# 必要に応じてブランチプッシュ
git push -u origin feature/new-auth

# PR作成（HEREDOCでbody指定）
gh pr create --title "feat: JWT認証機能の追加" --body "$(cat <<'EOF'
## 概要
セキュリティ強化のため、JWT ベースの認証システムを導入しました。

## 変更内容
- JWT トークン生成・検証機能の実装
- ログイン・ログアウトエンドポイントの追加
- 認証ミドルウェアの実装
- フロントエンド認証状態管理の更新

## 技術的詳細
- jsonwebtoken ライブラリを使用
- リフレッシュトークン機能付き
- セキュアなトークン保存（httpOnly cookie）

## テスト
- [x] 認証APIの単体テスト追加
- [x] フロントエンド認証フローの統合テスト
- [x] セキュリティテスト実施
- [x] 既存機能への影響確認

## レビューのポイント
- JWT実装のセキュリティ要件
- トークン有効期限の設定妥当性
- エラーハンドリングの適切性

## 関連情報
- 関連Issue: #234 (認証機能追加要求)
- 設計資料: [authentication-design.md](docs/auth-design.md)
EOF
)"
```

### レビュー指針

#### レビュワーへの配慮
- **変更理由の明確化**
- **影響範囲の説明**
- **テスト方法の提示**
- **議論ポイントの明示**

#### セルフレビューチェックリスト
- [ ] コードの可読性
- [ ] パフォーマンスへの影響
- [ ] セキュリティ考慮事項
- [ ] 後方互換性
- [ ] ドキュメントの更新
- [ ] テストカバレッジ

### PRサイズガイドライン

#### 適切なPRサイズ
- **変更行数**: 200-400行以内（目安）
- **ファイル数**: 10-20ファイル以内
- **レビュー時間**: 30-60分以内

#### 大きなPRを避ける方法
```bash
# 機能を段階的に分割
git commit -m ":sparkles: 認証基盤の実装"
git commit -m ":sparkles: ログイン機能の追加" 
git commit -m ":sparkles: トークン管理機能の追加"

# 複数PRに分割
PR1: 認証基盤の実装
PR2: ログイン・ログアウト機能
PR3: フロントエンド統合
```

### マージ戦略

#### Squash and Merge（推奨）
- **用途**: 通常の機能追加・修正
- **利点**: 履歴がクリーン、コミットメッセージ統一
- **注意**: 個別コミットの詳細は失われる

#### Merge Commit
- **用途**: 重要な機能、複数開発者での作業
- **利点**: 完全な履歴保持
- **注意**: 履歴が複雑になりがち

#### Rebase and Merge
- **用途**: 小さな修正、直線的な履歴維持
- **利点**: クリーンな一直線履歴
- **注意**: コンフリクト解決が複雑な場合あり

### PR運用のベストプラクティス

#### 作成時
1. **Draft PR活用**: 作業中は Draft状態で共有
2. **早期フィードバック**: 設計段階でのレビュー依頼
3. **CI/CDチェック**: 全自動テスト通過を確認

#### レビュー時
1. **建設的フィードバック**: 改善提案を具体的に
2. **迅速なレスポンス**: 24時間以内の初回レビュー
3. **承認基準明確化**: 何をもって承認とするか

#### マージ後
1. **ブランチクリーンアップ**: 不要ブランチの削除
2. **デプロイ確認**: 本番環境での動作確認
3. **ドキュメント更新**: 必要に応じて関連ドキュメント更新

### トラブルシューティング

#### よくある問題と対策

**コンフリクト発生時**
```bash
# 最新のmainをfetch
git fetch origin main

# リベースでコンフリクト解決
git rebase origin/main

# コンフリクト解決後、強制プッシュ
git push --force-with-lease
```

**CI失敗時**
- テスト結果を詳細確認
- ローカルで同条件再現
- 修正コミット追加（fixupコミット推奨）

**レビュー長期化時**
- レビュワーに直接連絡
- PRの優先度明確化
- 必要に応じて分割検討

### 関連リンク

- [GitHub Flow](https://docs.github.com/en/get-started/quickstart/github-flow)
- [PR Best Practices](https://github.blog/2015-01-21-how-to-write-the-perfect-pull-request/)
- [Code Review Guidelines](https://google.github.io/eng-practices/review/)