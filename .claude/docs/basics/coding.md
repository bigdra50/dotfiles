# コーディングプラクティス

## 原則

### 関数型アプローチ (FP)

- 純粋関数を優先
- 不変データ構造を使用
- 副作用を分離
- 型安全性を確保

### ドメイン駆動設計 (DDD)

- 値オブジェクトとエンティティを区別
- 集約で整合性を保証
- リポジトリでデータアクセスを抽象化
- 境界付けられたコンテキストを意識

#### ドメインサービスの扱い

ドメインサービスは最終手段として扱うことが重要です

- 原則として、ビジネスロジックは値オブジェクトやエンティティにカプセル化する
- ドメインサービスの濫用は以下の問題を引き起こすリスクがある：

  - ドメインモデルの貧血化
  - 振る舞いの漏れ出し
  - オブジェクト指向の原則違反
  - テストの複雑化

- **ドメインサービスを使う場合**：

  - 複数の集約にまたがる処理で、どちらにも属さない場合のみ
  - エンティティや値オブジェクトに配置すると不自然な場合のみ
  - 外部サービスとの連携が必要な場合（この場合はアプリケーションサービスも検討）

- **実装前のチェックリスト**：
  1. この振る舞いは特定のエンティティや値オブジェクトに属せないか？
  2. 新しい値オブジェクトを作ることで解決できないか？
  3. 既存のドメインオブジェクトのメソッドとして実装できないか？

まずドメインオブジェクト内での実装を試み、それが本当に不自然な場合のみドメインサービスを検討することを推奨します

### テスト駆動開発 (TDD)

- Red-Green-Refactorサイクル
- テストを仕様として扱う
- 小さな単位で反復
- 継続的なリファクタリング

## 実装パターン

### リポジトリ

- ドメインモデルのみを扱う
- 永続化の詳細を隠蔽
- テスト用のインメモリ実装を提供

### アダプターパターン

- 外部依存を抽象化
- インターフェースは呼び出し側で定義
- テスト時は容易に差し替え可能

## 実装手順

1. **型設計**

   - まず型を定義
   - ドメインの言語を型で表現

2. **純粋関数から実装**

   - 外部依存のない関数を先に
   - テストを先に書く

3. **副作用を分離**

   - IO操作は関数の境界に押し出す
   - 副作用を持つ処理をPromiseでラップ

4. **アダプター実装**
   - 外部サービスやDBへのアクセスを抽象化
   - テスト用モックを用意

## プラクティス

- 小さく始めて段階的に拡張
- 過度な抽象化を避ける
- コードよりも型を重視
- 複雑さに応じてアプローチを調整

## コードスタイル

- 不変更新パターンの活用
- 早期リターンで条件分岐をフラット化
- エラーとユースケースの列挙型定義

## テスト戦略

- 純粋関数の単体テストを優先
- インメモリ実装によるリポジトリテスト
- テスト可能性を設計に組み込む
- アサートファースト：期待結果から逆算
