#!/usr/bin/env bash
# =============================================================================
# Dotfiles Bootstrap Script
# =============================================================================
# This script sets up a new machine from scratch with minimal dependencies
# Requirements: curl or wget, git
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/bigdra50/dotfiles/main/bootstrap | bash
#   or
#   DOTFILES_DIR=$HOME/custom/path bash bootstrap

set -euo pipefail

# Configuration
DOTFILES_REPO="https://github.com/bigdra50/dotfiles.git"
DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dev/github.com/bigdra50/dotfiles}"
MAX_RETRIES=4
RETRY_DELAY=2

# =============================================================================
# Inline helpers (needed before lib.sh is available via clone)
# =============================================================================

_RED='\033[0;31m'
_GREEN='\033[0;32m'
_YELLOW='\033[1;33m'
_BLUE='\033[0;34m'
_CYAN='\033[0;36m'
_NC='\033[0m'

_info()    { echo -e "${_BLUE}==>${_NC} $1"; }
_success() { echo -e "${_GREEN}✓${_NC} $1"; }
_error()   { echo -e "${_RED}✗${_NC} $1" >&2; }
_warning() { echo -e "${_YELLOW}!${_NC} $1"; }

_command_exists() { command -v "$1" >/dev/null 2>&1; }

_detect_platform() {
    case "$(uname -s)" in
        Darwin*) echo "macos" ;;
        Linux*)
            if grep -qi microsoft /proc/version 2>/dev/null; then
                echo "wsl"
            else
                echo "linux"
            fi
            ;;
        MINGW*|MSYS*|CYGWIN*) echo "windows" ;;
        *) echo "unknown" ;;
    esac
}

_detect_arch() {
    case "$(uname -m)" in
        x86_64|amd64) echo "x86_64" ;;
        aarch64|arm64) echo "aarch64" ;;
        *) echo "$(uname -m)" ;;
    esac
}

_retry_command() {
    local attempt=1
    local delay=$RETRY_DELAY

    while [ $attempt -le $MAX_RETRIES ]; do
        if "$@"; then
            return 0
        fi
        if [ $attempt -lt $MAX_RETRIES ]; then
            _warning "Command failed (attempt $attempt/$MAX_RETRIES). Retrying in ${delay}s..."
            sleep $delay
            delay=$((delay * 2))
            attempt=$((attempt + 1))
        else
            _error "Command failed after $MAX_RETRIES attempts"
            return 1
        fi
    done
}

# =============================================================================
# Installation Functions
# =============================================================================

install_git() {
    if _command_exists git; then
        _success "git is already installed ($(git --version))"
        return 0
    fi

    _info "Installing git..."

    case "$PLATFORM" in
        macos)
            if ! xcode-select -p &>/dev/null; then
                _info "Installing Xcode Command Line Tools..."
                xcode-select --install 2>/dev/null || true
                until xcode-select -p &>/dev/null; do
                    sleep 5
                done
            fi
            ;;
        linux|wsl)
            if _command_exists apt-get; then
                _retry_command sudo apt-get update
                _retry_command sudo apt-get install -y git curl build-essential
            elif _command_exists dnf; then
                _retry_command sudo dnf install -y git curl gcc gcc-c++ make
            elif _command_exists pacman; then
                _retry_command sudo pacman -Syu --noconfirm git curl base-devel
            else
                _error "No supported package manager found. Please install git manually."
                exit 1
            fi
            ;;
        *)
            _error "Unsupported platform: $PLATFORM"
            exit 1
            ;;
    esac

    if _command_exists git; then
        _success "git installed successfully ($(git --version))"
    else
        _error "Failed to install git"
        exit 1
    fi
}

clone_dotfiles() {
    if [[ -d "$DOTFILES_DIR" ]]; then
        _info "Dotfiles directory already exists at $DOTFILES_DIR"
        cd "$DOTFILES_DIR"

        if [[ -d .git ]]; then
            _info "Updating existing repository..."

            current_remote=$(git remote get-url origin 2>/dev/null || echo "")
            if [[ -z "$current_remote" ]]; then
                git remote add origin "$DOTFILES_REPO"
            elif [[ "$current_remote" != "$DOTFILES_REPO" ]]; then
                _warning "Remote URL mismatch. Updating to $DOTFILES_REPO"
                git remote set-url origin "$DOTFILES_REPO"
            fi

            _retry_command git pull --rebase origin main || {
                _warning "Failed to pull latest changes. Continuing with existing version..."
            }
        else
            _warning "Directory exists but is not a git repository. Skipping update."
        fi
    else
        _info "Cloning dotfiles repository..."
        mkdir -p "$(dirname "$DOTFILES_DIR")"
        _retry_command git clone "$DOTFILES_REPO" "$DOTFILES_DIR"
        cd "$DOTFILES_DIR"
    fi

    _success "Dotfiles repository ready at $DOTFILES_DIR"
}

show_summary() {
    echo ""
    echo -e "${_CYAN}╔════════════════════════════════════════════════╗${_NC}"
    echo -e "${_CYAN}║${_NC}  ${_GREEN}Bootstrap Completed${_NC}                         ${_CYAN}║${_NC}"
    echo -e "${_CYAN}╚════════════════════════════════════════════════╝${_NC}"
    echo ""
    echo "  Platform:      $PLATFORM ($ARCH)"
    echo "  Dotfiles Dir:  $DOTFILES_DIR"
    echo "  Shell:         $SHELL"
    echo ""
    echo "  Next steps:"
    echo "    1. Restart your shell or: source ~/.zshrc"
    echo "    2. Customize: ~/.zshrc_local, ~/.gitconfig_local"
    echo ""

    case "$PLATFORM" in
        wsl)
            echo "  WSL tips:"
            echo "    - git config --global core.autocrlf input"
            echo ""
            ;;
        macos)
            if [[ "$ARCH" == "aarch64" ]]; then
                echo "  Apple Silicon: Homebrew at /opt/homebrew"
                echo ""
            fi
            ;;
    esac

    if [[ "$SHELL" != */zsh ]] && _command_exists zsh; then
        echo "  Switch to zsh: chsh -s $(which zsh)"
        echo ""
    fi
}

# =============================================================================
# Main
# =============================================================================

main() {
    local start_time=$(date +%s)

    echo ""
    echo -e "${_CYAN}╔════════════════════════════════════════════════╗${_NC}"
    echo -e "${_CYAN}║${_NC}  ${_BLUE}Dotfiles Bootstrap${_NC}                          ${_CYAN}║${_NC}"
    echo -e "${_CYAN}╚════════════════════════════════════════════════╝${_NC}"
    echo ""

    PLATFORM=$(_detect_platform)
    ARCH=$(_detect_arch)
    _info "Detected platform: $PLATFORM ($ARCH)"

    if [[ "$PLATFORM" == "unknown" ]]; then
        _error "Unsupported operating system"
        exit 1
    fi

    _info "Checking prerequisites..."
    if ! _command_exists curl && ! _command_exists wget; then
        _error "Neither curl nor wget found. Please install one of them first."
        exit 1
    fi

    echo ""

    _info "Step 1/3: Installing git..."
    install_git
    echo ""

    _info "Step 2/3: Cloning dotfiles repository..."
    clone_dotfiles
    echo ""

    _info "Step 3/3: Running installation..."
    cd "$DOTFILES_DIR"
    export INTERACTIVE=false

    if bash "$DOTFILES_DIR/install.sh"; then
        _success "Installation completed!"
    else
        _error "Installation failed"
        _warning "You can try running './install.sh' manually to see detailed errors"
        exit 1
    fi

    echo ""

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    _info "Bootstrap completed in ${duration}s"

    show_summary
}

main "$@"
